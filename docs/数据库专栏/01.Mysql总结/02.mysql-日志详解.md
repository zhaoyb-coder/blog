---
title: Mysql日志详解
date: 2023-12-11 13:31:16
permalink: /data/2f28ce/
categories:
  - Mysql
tags:
  - mysql-log
author: 
  name: zhaoyb
  link: https://github.com/zhaoyb-coder
---

# Mysql日志详解

## 1、Binlog

`Binlog属于Mysql server层的维护的一种二进制日志`，主要记录对于对Mysql数据更新的SQL语句，以“event”的形式保存在磁盘中

`Binlog的写入时机是SQL transaction 执行完，但是任何相关的Locks还没释放或者事务还没最终commit前`，这样就保证了Binlog记录的操作时序与数据库实际的数据变更顺序一致

### 1.1、Binlog的主要作用

+ 数据恢复：通过mysqlbinlog工具恢复数据
+ 主从复制：MySQL在Master端开启binlog，Master把它的二进制日志传递给slaves并回放(中继日志)来达到master-slave数据一致的目的
  ![image-20231211163625304](https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231211163625304.png)

### 1.2、Binlog文件类型

+ 二进制日志索引文件(.index)：记录所有的二进制文件
  ![image-20231211153708238](https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231211153708238.png)
+ 二进制日志文件(.00000*)：记录所有 DDL 和 DML 语句事件
  ![image-20231211153741608](https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231211153741608.png)

### 1.3、相关命令

```sql
-- 检查 Binlog 文件是否已开启
show variables like '%log_bin%';

-- 查看binlog列表
show binary logs;

-- 查看最新的binlog
show master status;

-- 查看 Binlog 日志
mysqlbinlog mysql-bin.00000* | more

-- 查看当前 Binlog 文件对应的详细事件信息
show binlog events in 'mysql-bin.00000*';

-- 查询当前 Binlog 日志使用格式 Statement|Row|Mixed
show global variables like '%binlog_format%';

--mysqlbinlog 命令手动恢复数据 
mysqlbinlog --start-position=0  --stop-position=500  mysql-bin.00000* > /root/back.sql;
```

### 1.4、相关参数

my.cnf文件中对于binlog的配置参数：

+ log-bin=/home/mysql/binlog/  设置此参数表示启用binlog功能，并制定二进制日志的存储目录 
+ max_binlog_size=104857600  日志文件最大字节（单位：字节） Binlog 最大和默认值是 1G
+ expire_logs_days = 7  设置了只保留7天BINLOG（单位：天）
+ binlog-do-db=db_name  binlog日志只记录指定库的更新 
+ binlog-ignore-db=db_name  binlog日志不记录指定库的更新 
+ sync_binlog=0  写缓冲多少次，刷一次磁盘，默认0 

------

Binlog的过期删除不是服务定时执行，而是由事件触发的，能够触发的事件包括

+ 服务器重启

+ 服务器被更新
+ 日志达到了最大长度
+ 日志被刷新

------

Binlog的刷新频率：sync_binlog默认为0 ，代表由操作系统根据自身负载自行决定多久写一次磁盘，如果修改为1或者n，那么代表执行每1次或者n次事务提交时会立刻写入磁盘

------

### 1.5、日志格式

Binlog提供了三种模式来记录日志：

+ Statement 模式：基于 SQL 语句的复制(statement-based replication-SBR)
  优点：不需要记录每一行的变化，减少了binlog日志量，节约了IO，提高性能

  缺点：特定函数功能不能进行复制，如sleep()、UUID()

+ Row 模式：基于行的复制(row-based replication-RBR)
  优点：非常清楚的记录下每一行数据修改的细节
  缺点：所有的执行的语句当记录到日志中的时候，都将以每行记录的修改来记录，这样可能会产生大量的日志内容

+ Mixed 模式：混合模式复制(mixed-based replication-MBR)
  是以上两种level的混合使用，一般的语句修改使用statment格式保存binlog，如一些函数，statement无法完成主从复制的操作，则采用row格式保存binlog,MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式

## 2、redo log

`redo log属于Mysql Innodb引擎层维护的日志数据`，记录的数据是事务执行过程中的执行情况，主要`用来保证事务的持久性`

![image-20231211162212610](https://raw.githubusercontent.com/zhaoyb-coder/pic-repo/main/image-20231211162212610.png)



## 3、undo log

## 4、慢查询日志

