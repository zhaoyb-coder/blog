---
title: Javassist字节码工具使用
date: 2024-01-17 09:13:16
permalink: /be/105102/
categories:
  - JVM
tags:
  - Javassist
author: 
  name: zhaoyb
  link: https://github.com/zhaoyb-coder
---

# Javassist字节码工具使用

## 1、JavaAgent

打算趁着空闲时间开发一个小工具，用来做线上字节码调试，仿照阿里的Arthas,做一个带有可视化界面的工具

### 1.1、动态Attach到目标进程

1、首先新建一个Maven项目[ ByteCodeTool ]，pom文件如下所示：

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>org.example</groupId>
  <artifactId>ByteCodeTool</artifactId>
  <version>1.0-SNAPSHOT</version>
  <packaging>jar</packaging>

  <name>ByteCodeTool</name>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.javassist</groupId>
      <artifactId>javassist</artifactId>
      <version>3.28.0-GA</version>
    </dependency>
    <dependency>
      <groupId>net.bytebuddy</groupId>
      <artifactId>byte-buddy-agent</artifactId>
      <version>1.12.14</version>
    </dependency>
    <dependency>
      <groupId>com.sun.tools</groupId>
      <artifactId>attach</artifactId>
      <version>8</version>
    </dependency>
  </dependencies>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <configuration>
          <source>8</source>
          <target>8</target>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-shade-plugin</artifactId>
        <version>3.5.0</version>
        <configuration>
          <transformers>
            <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
              <manifestEntries>
                <Main-Class>org.example.AttachAgent</Main-Class>
                <Agent-Class>org.example.MyAgent</Agent-Class>
                <Can-Retransform-Classes>true</Can-Retransform-Classes>
              </manifestEntries>
            </transformer>
          </transformers>
        </configuration>
        <executions>
          <execution>
            <phase>package</phase>
            <goals>
              <goal>shade</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>

</project>

```

2、新建MyAgent类

```java
package org.example;

import javassist.*;

import java.lang.instrument.Instrumentation;

/**
 * @author zhaoyubo
 * @title MyAgent
 * @description 动态Attach
 * @create 2024/1/17 10:19
 **/
public class MyAgent {
    public static void agentmain(String agentArgs, Instrumentation inst) {
        try {
            System.out.println("+++++++++++++++++++++Attach success+++++++++++++++++++++");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

3、新增AttachAgent启动类

```java
package org.example;

import com.sun.tools.attach.VirtualMachine;
import com.sun.tools.attach.VirtualMachineDescriptor;

import java.net.URL;
import java.nio.file.Paths;
import java.util.Comparator;
import java.util.List;
import java.util.Scanner;

/**
 * @author zhaoyubo
 * @title AttachAgent
 * @description 参考Arthas动态获取java进程ID，动态Attach
 * @create 2024/1/17 10:20
 **/
public class AttachAgent {
    public static void main(String[] args) {
        String pid = "";
        Scanner scanner = new Scanner(System.in);
        List<VirtualMachineDescriptor> jps = VirtualMachine.list();
        jps.sort(Comparator.comparing(VirtualMachineDescriptor::displayName));
        int i = 0;
        for (; i < jps.size(); i++) {
            System.out.printf("[%s] %s %s%n", i, jps.get(i).id(), jps.get(i).displayName());
        }
        System.out.printf("[%s] %s%n", i, "Custom PID");
        System.out.println("++++++++++++++Please enter the serial number+++++++++++++++");
        while (true) {
            int index = scanner.nextInt();
            if (index < 0 || index > i) continue;
            if (index == i) {
                System.out.println("++++++++++++Please enter the PID++++++++++++");
                pid = String.valueOf(scanner.nextInt());
                break;
            }
            pid = jps.get(index).id();
            break;
        }
        try {
            System.out.printf("++++++++++++The PID is %s%n++++++++++++", pid);
            VirtualMachine vm = VirtualMachine.attach(pid);
            URL jarUrl = MyAgent.class.getProtectionDomain().getCodeSource().getLocation();
            String curJarPath = Paths.get(jarUrl.toURI()).toString();
            vm.loadAgent(curJarPath);
            vm.detach();
            System.out.println("++++++++++++Attach finish++++++++++++");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

4、启动，测试

```shell
工具进程窗口：
> java -jar ByteCodeTool-1.0-SNAPSHOT.jar
[0] 2992
[1] 3256 ByteCodeTool-1.0-SNAPSHOT.jar
[2] 43476 afs-service-1.0.1.jar
[3] 1764 org.example.MainFrame
[4] 18336 org.jetbrains.idea.maven.server.RemoteMavenServer36
[5] Custom PID
++++++++++++++Please enter the serial number+++++++++++++++
2
++++++++++++The PID is 43476++++++++++++
++++++++++++Attach finish++++++++++++

被Attach的进程窗口：
> +++++++++++++++++++++Attach success+++++++++++++++++++++
```

